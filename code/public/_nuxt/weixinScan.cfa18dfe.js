import{a as X,r as o,b as Y,e as Z,J as r,t as j,N as ee,f as te,h as d,i as g,F as K,y as l,j as n,l as z,k as i,C as ae,D as le,E as ne,m as oe,o as f,A as O,x as se,u as P,a2 as ie,G as ue}from"./entry.b3d0478f.js";import ce from"./imageCode.e7d995d7.js";import"./_commonjsHelpers.86de73f2.js";import"./_commonjs-dynamic-modules.302442b1.js";const u=v=>(ae("data-v-8e008b20"),v=v(),le(),v),re={class:"weixin"},de=u(()=>l("div",null,"微信扫码一键登录/注册",-1)),ve={class:"weixin-qrcode"},pe=["src"],me=u(()=>l("div",{class:"name"},"二维码失效，请点击重试",-1)),_e=u(()=>l("div",{class:"weixin-bottom"},[l("div",null,"使用微信扫码-关注公众号登录/注册")],-1)),ge=u(()=>l("div",{class:"weixin-title"},"绑定手机号",-1)),fe={class:"form"},he={class:"code"},Ce={class:"agree"},xe=u(()=>l("div",null,"登录或注册即代表同意",-1)),ke=u(()=>l("div",null,"用户协议",-1)),ye=u(()=>l("div",null,"和",-1)),Ie=u(()=>l("div",null,"隐私政策",-1)),be=X({__name:"weixinScan",props:{active:{}},emits:["update:active"],setup(v,{expose:R,emit:U}){const W=v,{Modal:T}=ne,b=o(""),p=Y(),E=Z(),N=o(!1),{proxy:t}=oe(),m=o(""),s=o(null),h=o(0),C=o(!1),x=o(null),k=o(!1),S=r("authtoken"),e=o({captchaCode:"",phone:"",registerCode:"",ticket:"",time:90,btnloading:!1,single:!1}),{active:q}=j(W);clearInterval(x.value),clearInterval(s.value);const A=()=>{U("update:active",Number(q.value)-1),clearInterval(s.value),C.value=!1},V=()=>{clearInterval(s.value),N.value=!1,C.value=!1,m.value="",e.value.single=!1,t.$api.getLoginQrcode({channelType:"WECHAT"}).then(c=>{e.value.ticket=c.data.ticket,h.value=c.data.seconds,m.value="https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket="+e.value.ticket,s.value=setInterval(()=>{if(h.value=Number(h.value)-3,h.value<=0){clearInterval(s.value),C.value=!0;return}t.$api.longPollingForScanQrCode({ticket:e.value.ticket}).then(a=>{if(a.data.bindWechatState=="INTI"&&console.log("初始"),a.data.bindWechatState=="SCAN_QRCORE"&&(clearInterval(s.value),N.value=!0),a.data.bindWechatState=="BIND"){if(S.value=JSON.stringify(a.data),clearInterval(s.value),r("secretKey").value){let w={inviteCode:r("secretKey").value,loginCode:a.data.loginCode};t.$api.aggregatedAddTeamUser(w).then(I=>{t.$isEmpty(I.data.resultHint)||setTimeout(()=>{T.confirm({okText:"我知道了",cancelText:"",content:I.data.resultHint})},3e3)}),r("secretKey").value=null}B()}})},3e3)})},B=()=>{p.fullPath?E.push(p.fullPath):E.push("/"),t.$isEmpty(b.value)||setTimeout(()=>{T.confirm({okText:"我知道了",cancelText:"",content:b.value})},3e3),p.setTopNavList(t)},J=()=>{if(t.$isEmpty(e.value.phone)){t.$Message.error("请输入您的手机号");return}if(t.$isEmpty(e.value.registerCode)){t.$Message.error("请输入验证码");return}if(!e.value.single){t.$Message.error("请同意服务协议");return}k.value=!0;let c={phone:e.value.phone,ticket:e.value.ticket,registerCode:e.value.registerCode,secretKey:r("secretKey").value?r("secretKey").value:""};t.$api.loginBindphone(c).then(a=>{k.value=!1,b.value=a.data.resultHint,S.value=JSON.stringify(a.data),r("secretKey").value=null,B()}).catch(a=>{k.value=!1})};R({chooseWeixin:V}),ee(()=>{clearInterval(s.value)}),te(()=>{S.value=null});const y=o(),L=()=>{e.value.phone.length==11&&y.value.getCodeImg(e.value.phone,"BING_PHONE")},D=()=>{if(t.$isEmpty(e.value.phone))return t.$Message.error("请输入您的手机号");if(t.$isEmpty(y.value.captchaCode))return t.$Message.error("请输入图形验证码");e.value.btnloading=!0;let c={captchaCode:y.value.captchaCode,account:e.value.phone,sendCodeType:"BING_PHONE"};t.$api.tenant_sendRegisterCode(c).then(()=>{clearInterval(x.value),t.$Message.success("验证码已发送,请注意查收"),e.value.btnloading=!1,x.value=setInterval(()=>{e.value.time=Number(e.value.time)-1,e.value.time==0&&(e.value.time=90,clearInterval(x.value))},1e3)}).catch(()=>{e.value.btnloading=!1})};return(c,a)=>{const w=d("Spin"),I=d("Icon"),M=d("Input"),$=d("FormItem"),F=d("Button"),G=d("Checkbox"),H=ie,Q=d("Form");return f(),g("div",re,[N.value?(f(),g(K,{key:1},[ge,l("div",fe,[n(Q,null,{default:i(()=>[n($,null,{default:i(()=>[n(M,{modelValue:e.value.phone,"onUpdate:modelValue":a[0]||(a[0]=_=>e.value.phone=_),maxlength:11,size:"large",placeholder:"手机号",onOnChange:L},null,8,["modelValue"])]),_:1}),n($,null,{default:i(()=>[n(ce,{ref_key:"imgCode",ref:y},null,512),l("div",he,[n(M,{size:"large",modelValue:e.value.registerCode,"onUpdate:modelValue":a[1]||(a[1]=_=>e.value.registerCode=_),placeholder:"验证码"},null,8,["modelValue"]),n(F,{size:"large",disabled:!(e.value.time>=90),loading:e.value.btnloading,onClick:D,class:"btn"},{default:i(()=>[O(se(e.value.time>=90?"获取验证码":e.value.time+"s后重新获取"),1)]),_:1},8,["disabled","loading"])])]),_:1}),n($,null,{default:i(()=>[n(F,{class:"btn",type:"primary",size:"large",onClick:J,loading:k.value},{default:i(()=>[O("登录/注册")]),_:1},8,["loading"]),l("div",Ce,[n(G,{modelValue:e.value.single,"onUpdate:modelValue":a[2]||(a[2]=_=>e.value.single=_)},null,8,["modelValue"]),xe,n(H,{to:P(p).configuration.userServiceLink},{default:i(()=>[ke]),_:1},8,["to"]),ye,n(H,{to:P(p).configuration.privacyPolicy},{default:i(()=>[Ie]),_:1},8,["to"])])]),_:1})]),_:1})])],64)):(f(),g(K,{key:0},[l("div",{class:"weixin-top"},[de,l("a",{onClick:A},"使用手机号登录")]),l("div",ve,[n(w,{size:"large",fix:"",show:!m.value},null,8,["show"]),m.value?(f(),g("img",{key:0,src:m.value},null,8,pe)):z("",!0),C.value?(f(),g("div",{key:1,onClick:V,class:"weixin-expired"},[l("div",null,[n(I,{type:"md-repeat",size:"30"}),me])])):z("",!0)]),_e],64))])}}});const Te=ue(be,[["__scopeId","data-v-8e008b20"]]);export{Te as default};
